---
title: "Report diferential analysis"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
      toc: yes
      toc_depth: 3
      theme: simplex
params:
  obj1: "path to obj"
  thr: 'percentage edges to plot'

---

```{r message=FALSE, warning=FALSE, echo=F, include=F, echo=FALSE}
require(igraph)
require(dplyr)
require(tibble)
require(tidyr)
require(patchwork)
require(stringr)
require(LRAnalytics)
require(ggraph)
require(graphlayouts)
require(pals)


```

## Differential Cell Cell Interaction Plot (CCI)

```{r fig.align='center', fig.height=8, fig.width=8,message=FALSE, warning=FALSE, echo=F}
path <-params$obj1
thresh <- params$thr
low <- thresh/2
high <- thresh+low
all_data <- readRDS(path)
tmp_max <- 0
for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE)){
      var <- abs(E(all_data@graphs[[curr]])$MeanLR)
      if(max(var) > tmp_max){
        tmp_max <- max(var)
      }
  }
}
for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE)){
    curr_net <- all_data@graphs[[curr]]
    plotLR_cci(curr_net,
               all_data@colors[V(curr_net)$name],
               paste0(curr,' CCI'),all_data@coords[V(curr_net)$name,],leg=TRUE,low=low,high = high,emax = tmp_max)
  }
}
```

## Differential Cell Cell Frequency of Ligands and Receptors

```{r fig.align='center', fig.height=5, fig.width=15,message=FALSE, warning=FALSE,echo=F}

for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE)){
    curr_net <- all_data@graphs[[curr]]
    in_deg <- table(all_data@tables[[curr]]$Ligand.Cluster)
    in_deg <- tibble::tibble(cells=names(in_deg),inter=in_deg)
    out_deg <-table(all_data@tables[[curr]]$Receptor.Cluster)
    out_deg <- tibble::tibble(cells=names(out_deg),inter=out_deg)
    p1 <- ggplot2::ggplot(in_deg,ggplot2::aes(x=inter,y=reorder(cells,inter),fill=cells))+
      ggplot2::geom_bar(stat="identity")+
      ggplot2::ggtitle('Ligand')+
      ggplot2::ylab('Cell')+
      ggplot2::xlab('Interactions')+
      ggplot2::scale_fill_manual(values = data@colors, breaks = names(data@coords))+
      theme_minimal()
    lig_order <- all_data@rankings[[curr]]$ligand_count[match(names(all_data@colors),in_deg$cells)]
    rec_order <- all_data@rankings[[curr]]$receptor_count[match(names(all_data@colors),out_deg$cells)]
    df <- tibble(nodes=names(all_data@colors),ligand_ranking=lig_order,receptor_ranking=rec_order)
    df <- reshape2::melt(df)
    levels(df$variable) <- 1:length(levels(df$variable))
    df$variable <- as.numeric(df$variable)
    p3 <- ggplot2::ggplot(df, ggplot2::aes(variable, value, color = nodes)) +
          ggplot2::geom_line(aes(color = nodes), size = 2) +
          ggplot2::geom_point(ggplot2::aes(color = nodes), size = 4) +
          ggplot2::scale_x_discrete(name ="node features",limits=c(limits=c('ligand_frequency','receptor_frequency')))+
          ggplot2::scale_y_continuous(name='rank',trans = "reverse", breaks = unique(df$value))+
          ggplot2::scale_color_manual(values = data@colors, breaks = names(data@coords))+
          ggplot2::labs(title = "Cells LR Frequency")+ 
          ggplot2::theme(legend.position = "none")+
          ggplot2::theme_minimal()
    p2 <- ggplot2::ggplot(out_deg,ggplot2::aes(x=inter,y=reorder(cells,inter),fill=cells))+
      ggplot2::geom_bar(stat="identity")+
      ggplot2::ggtitle('Receptor')+
      ggplot2::scale_fill_manual(values = data@colors, breaks = names(data@coords))+
      ggplot2::ylab('Cell')+
      ggplot2::xlab('Interactions')+
      theme_minimal()
    print((p1+p2+p3)+plot_annotation(title = curr,tag_levels = 'A'))
  }
}
```


## Differential Gene_Cell Gene_Cell Interaction Plot (GGI): *Highest degree*

```{r fig.align='center', fig.height=8, fig.width=16,message=FALSE, warning=FALSE,echo=F}
for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE)){
    curr_net <- all_data@graphs_ggi[[curr]]
    plot_ggi(curr_net,color = all_data@colors)
  }
}
```

## Differential Gene_Cell Gene_Cell Interaction Plot (GGI): *Articulation point*

```{r fig.align='center', fig.height=8, fig.width=16,message=FALSE, warning=FALSE,echo=F}
for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE)){
    curr_net <- all_data@graphs_ggi[[curr]]
    plot_articulation(curr_net,color = all_data@colors)
  }
}
```


## Differential Gene_Cell Gene_Cell Ranking Sending(out-degree) Receiving (in-degree)

```{r fig.align='center', fig.height=6, fig.width=10,message=FALSE, warning=FALSE,echo=F}

for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE)){
    curr_net <- all_data@graphs_ggi[[curr]]
    in_deg <- igraph::degree(curr_net, mode = 'in')
    in_deg <- tibble::tibble(cells=names(in_deg),inter=in_deg)
    out_deg <- igraph::degree(curr_net, mode = 'out')
    out_deg <- tibble::tibble(cells=names(out_deg),inter=out_deg)
    in_deg_data <-dplyr::top_n(in_deg, 25, inter)
    out_deg_data <- dplyr::top_n(out_deg, 25, inter)
    l_in <- ifelse(dim(in_deg_data)[1] >= 25, 25, dim(in_deg_data)[1])
    l_out <- ifelse(dim(out_deg_data)[1] >= 25, 25, dim(out_deg_data)[1])
    in_deg_data <- in_deg_data[1:l_in,]
    out_deg_data <- out_deg_data[1:l_out,]
    p1 <- ggplot2::ggplot(in_deg_data,ggplot2::aes(x=inter,y=reorder(cells,inter)))+
      ggplot2::geom_bar(stat="identity",fill='green3')+
      ggplot2::ggtitle('Receiving Interactions')+
      ggplot2::ylab('Cell')+
      ggplot2::xlab('Number of interactions')
    p2 <- ggplot2::ggplot(out_deg_data,ggplot2::aes(x=inter,y=reorder(cells,inter)))+
      ggplot2::geom_bar(stat="identity",fill='green4')+
      ggplot2::ggtitle('Sending Interactions')+
      ggplot2::ylab('Cell')+
      ggplot2::xlab('Number of interactions')
    print((p1+p2)+plot_annotation(title = curr,tag_levels = 'A'))
  }
}
```











