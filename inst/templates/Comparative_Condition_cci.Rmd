---
title: "Report diferential analysis"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
      toc: yes
      toc_depth: 3
      theme: simplex

params:
  obj1: "path to obj"
  thr: 'percentage edges to plot'

---

```{r message=FALSE, warning=FALSE, echo=FALSE, include=FALSE, echo=FALSE}
require(igraph)
require(dplyr)
require(tibble)
require(tidyr)
require(patchwork)
require(stringr)
require(CrossTalkeR)
require(ggraph)
require(factoextra)
require(graphlayouts)
require(pals)
require(extrafont)
require(colorBlindness)
require(DT)
require(ComplexHeatmap)
extrafont::loadfonts()
```


### Interaction Plot (CCI)




*Here, the cell-cell interaction is provided for each phenotype comparison between phenotypes.*

```{r fig.align='center', fig.height=8,fig.width=8,message=FALSE, warning=FALSE, echo=FALSE,fig.keep = 'all'}
for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE) & !str_detect(curr, 'ggi', negate = FALSE)){
      h <- head_of(all_data@graphs[[curr]],E(all_data@graphs[[curr]]))$name
      f <- tail_of(all_data@graphs[[curr]],E(all_data@graphs[[curr]]))$name
      curr_net<-all_data@graphs[[curr]]
      #curr_net <- subgraph.edges(all_data@graphs[[curr]],E(all_data@graphs[[curr]])[match(all_data@stats[[curr]]$columns_name[all_data@stats[[curr]]$p<=0.05],paste(h,f,sep = '_'),nomatch = F)])
        #low <- thr
        #E(curr_net)$inter <- E(curr_net)$inter.raw/max(E(curr_net)$inter.raw)
        par(cex.axis=7, cex.lab=7)
        plot_cci(graph=curr_net,
                 coords=all_data@coords[V(curr_net)$name,],
                 colors=all_data@colors[V(curr_net)$name],
                 plt_name=paste0(curr,' CCI'),
                 leg=TRUE,
                 low=0,
                 high=low/100,
                 log = TRUE,pg=all_data@rankings[[curr]]$Pagerank[V(curr_net)$name])
     }
}


```

### Pvalue Filtered Interaction Plot (CCI)

*Here, the cell-cell interaction is provided for each phenotype comparison between phenotypes.*

```{r fig.align='center', fig.height=8,fig.width=8,message=FALSE, warning=FALSE, echo=FALSE,fig.keep = 'all'}
path <-params$obj1
thr <- params$thr
all_data <- readRDS(path)
for(i in 1:length(names(all_data@tables))){
  curr <- names(all_data@tables)[i]
  if(str_detect(curr, '_x_', negate = FALSE) & !str_detect(curr, 'ggi', negate = FALSE)){
      h <- head_of(all_data@graphs[[curr]],E(all_data@graphs[[curr]]))$name
      f <- tail_of(all_data@graphs[[curr]],E(all_data@graphs[[curr]]))$name
      curr_net<-all_data@graphs[[curr]]
      curr_net <- subgraph.edges(all_data@graphs[[curr]],E(all_data@graphs[[curr]])[match(all_data@stats[[curr]]$columns_name[all_data@stats[[curr]]$p<=0.05],paste(h,f,sep = '_'),nomatch = F)])
        low <- thr
        E(curr_net)$inter <- E(curr_net)$inter.raw/max(E(curr_net)$inter.raw)
        par(cex.axis=7, cex.lab=7)
        plot_cci(graph=curr_net,
                 coords=all_data@coords[V(curr_net)$name,],
                 colors=all_data@colors[V(curr_net)$name],
                 plt_name=paste0(curr,' CCI'),
                 leg=TRUE,
                 low=0,
                 high=low/100,
                 log = TRUE,pg=all_data@rankings[[curr]]$Pagerank[V(curr_net)$name])
     }
}
```





### PCA CCI

*Here a Principal Component Analysis (PCA) is done using the cell-cell interaction topological measures. Each measure contribution is placed in the coordinate system.*


```{r fig.align='center',warning=FALSE,echo=FALSE}
path <-params$obj1
out <- c()
out1 <- list()
all_data <- readRDS(path)
for(i in 1:length(names(all_data@pca))){
     curr <- names(all_data@pca)[i]
     if(str_detect(curr, '_x_', negate = FALSE) & !str_detect(curr, '_ggi', negate = FALSE)){
     rmd_title <- paste0(curr,'_tbl')
     rmd_title1 <- paste0(curr,'_pca1')
     x <- max(abs(all_data@pca[[curr]]$x[,1]))
     y <- max(abs(all_data@pca[[curr]]$x[,2]))
     print(fviz_pca_biplot(data@pca[[curr]],
                    axes = c(1,2),
                    pointshape = 21, pointsize = 0.5,labelsize = 6,
                    repel = TRUE,max.overlaps=100,label='var')+
                    geom_text_repel(aes(label=rownames(all_data@pca[[curr]]$x)))+
                    xlim(-x, x)+
                    ylim(-y, y)+
                    ggtitle(curr)+
                    theme(text = element_text(size = 7.5),
                          axis.title = element_text(size = 7.5),
                          axis.text = element_text(size = 7.5)))

   }  
}

```


### Pagerank Log Ratio


```{r fig.align='center',warning=FALSE,echo=FALSE}
for(i in 2:length(names(all_data@rankings))){
  curr <- names(all_data@rankings)[i]
  if(str_detect(curr, '_x_', negate = FALSE) & !str_detect(curr, 'ggi', negate = FALSE)){
    signal <- ifelse(all_data@rankings[[curr]]$Pagerank < 0, 'negative','positive')
    print(ggplot(all_data@rankings[[curr]], aes(x=Pagerank,y=reorder(nodes,Pagerank),fill=signal))+
        geom_bar(stat="identity")+
        scale_fill_manual(values = c(Blue2DarkOrange18Steps[4],Blue2DarkOrange18Steps[14]))+
        theme_minimal())
  }  
}
```


### CCI Table

```{r fig.align='center',warning=FALSE,echo=FALSE}
path <-params$obj1
out <- c()
out1 <- list()
all_data <- readRDS(path)
for(i in 1:length(names(all_data@pca))){
     curr <- names(all_data@pca)[i]
     if(str_detect(curr, '_x_', negate = FALSE) & !str_detect(curr, '_ggi', negate = FALSE)){
     rmd_title <- paste0(curr,'_tbl')
     rmd_title1 <- paste0(curr,'_pca1')
     title <- paste0('\n\n#### Table PCA CCI ',curr)
     knit_expanded <- paste0("\n\n```{r , results='",rmd_title,"', echo=FALSE, warning=FALSE}\n\n
         pca <- all_data@pca[['",curr,"']]$x[,1:2]
         pca[,1] <- round(pca[,1],6)
         pca[,2] <- round(pca[,2],6)
         ranking <- cbind(all_data@rankings[['",curr,"']][,2:dim(all_data@rankings[['",curr,"']])[2]],pca[all_data@rankings[['",curr,"']]$nodes,])
         datatable(ranking,
                 caption='",curr,"',
                 extensions = 'Buttons',
                 options = list(dom = 'Bfrtip',
                                buttons = c('copy',
                                            'csv',
                                            'excel',
                                            'pdf', 'print'),
                               autoWidth = FALSE
                               )
                )\n\n```")
     out <- c(out,title,knit_expanded)
     out1[[curr]] <-knit_expanded
   }  
}

```

`r paste(knitr::knit(text = out), collapse = '\n')`
